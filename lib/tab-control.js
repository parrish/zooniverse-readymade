// Generated by CoffeeScript 1.7.1
(function() {
  var LEFT_CURSOR, RIGHT_CURSOR, SPACE, TabControl, TabSet,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __modulo = function(a, b) { return (a % b + +b) % b; };

  LEFT_CURSOR = 37;

  RIGHT_CURSOR = 39;

  SPACE = 32;

  TabControl = (function() {
    function TabControl(tab, panel, active) {
      this.tab = tab;
      this.panel = panel;
      if (active == null) {
        active = false;
      }
      this.destroy = __bind(this.destroy, this);
      this.deactivate = __bind(this.deactivate, this);
      this.activate = __bind(this.activate, this);
      this.tab.setAttribute('role', 'tab');
      this.tab.setAttribute('aria-controls', this.panel.id);
      this.panel.setAttribute('role', 'tabPanel');
      this.panel.setAttribute('aria-labelledby', this.tab.id);
      this.tab.setAttribute('aria-selected', active);
      this.panel.setAttribute('aria-selected', active);
      this.panel.setAttribute('aria-hidden', !active);
    }

    TabControl.prototype.activate = function() {
      this.panel.setAttribute('aria-selected', 'true');
      this.panel.setAttribute('aria-hidden', 'false');
      return this.tab.setAttribute('aria-selected', 'true');
    };

    TabControl.prototype.deactivate = function() {
      this.panel.setAttribute('aria-selected', 'false');
      this.panel.setAttribute('aria-hidden', 'true');
      return this.tab.setAttribute('aria-selected', 'false');
    };

    TabControl.prototype.destroy = function() {
      this.tab.removeAttribute('role');
      this.tab.removeAttribute('aria-controls');
      this.panel.removeAttribute('role');
      this.panel.removeAttribute('aria-labelledby');
      this.tab.removeAttribute('aria-selected');
      this.panel.removeAttribute('aria-selected');
      return this.panel.removeAttribute('aria-hidden');
    };

    return TabControl;

  })();

  TabSet = (function() {
    TabSet.prototype.tabcontrols = [];

    TabSet.prototype.active_index = 0;

    TabSet.prototype.focus_index = 0;

    function TabSet(tabcontrols) {
      this.tabcontrols = tabcontrols != null ? tabcontrols : [];
      this.destroy = __bind(this.destroy, this);
      this.goTo = __bind(this.goTo, this);
      this.activate = __bind(this.activate, this);
      this.moveFocus = __bind(this.moveFocus, this);
      this.handleFocus = __bind(this.handleFocus, this);
      this.handleKeydown = __bind(this.handleKeydown, this);
      this.handleClick = __bind(this.handleClick, this);
      this.add = __bind(this.add, this);
    }

    TabSet.prototype.add = function(tab, panel, active) {
      var tab_control;
      if (active == null) {
        active = false;
      }
      if (tab[0] != null) {
        tab = tab[0];
      }
      if (panel[0] != null) {
        panel = panel[0];
      }
      tab_control = new TabControl(tab, panel, active);
      this.tabcontrols.push(tab_control);
      tab.addEventListener('click', this.handleClick);
      tab.addEventListener('keydown', this.handleKeydown);
      tab.addEventListener('focus', this.handleFocus);
      return tab_control;
    };

    TabSet.prototype.handleClick = function(e) {
      return this.activate(e.currentTarget);
    };

    TabSet.prototype.handleKeydown = function(e) {
      var new_index;
      if (e.which === LEFT_CURSOR) {
        new_index = Math.max(0, this.focus_index - 1);
      }
      if (e.which === RIGHT_CURSOR) {
        new_index = Math.min(this.tabcontrols.length - 1, this.focus_index + 1);
      }
      if (e.which === SPACE) {
        e.currentTarget.click();
      }
      if (new_index != null) {
        return this.moveFocus(new_index);
      }
    };

    TabSet.prototype.handleFocus = function(e) {
      var i, tabcontrol, _i, _len, _ref, _results;
      _ref = this.tabcontrols;
      _results = [];
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        tabcontrol = _ref[i];
        if (tabcontrol.tab === e.currentTarget) {
          _results.push(this.focus_index = i);
        }
      }
      return _results;
    };

    TabSet.prototype.moveFocus = function(new_index) {
      this.tabcontrols[new_index].tab.focus();
      return this.focus_index = new_index;
    };

    TabSet.prototype.activate = function(el) {
      var i, tab_control, _i, _len, _ref, _results;
      if (el[0] != null) {
        el = el[0];
      }
      if (el.getAttribute('aria-selected') === 'true') {
        return;
      }
      _ref = this.tabcontrols;
      _results = [];
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        tab_control = _ref[i];
        if (tab_control.tab.id === el.id || tab_control.panel.id === el.id) {
          tab_control.activate();
          _results.push(this.active_index = i);
        } else {
          _results.push(tab_control.deactivate());
        }
      }
      return _results;
    };

    TabSet.prototype.goTo = function(index) {
      index = __modulo(index, this.tabcontrols.length);
      if (this.tabcontrols[index]) {
        return this.activate(this.tabcontrols[index].tab);
      }
    };

    TabSet.prototype.destroy = function() {
      var tabcontrol, _i, _len, _ref, _results;
      _ref = this.tabcontrols;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tabcontrol = _ref[_i];
        tabcontrol.tab.removeEventListener('click', this.handleClick);
        _results.push(tabcontrol.destroy());
      }
      return _results;
    };

    return TabSet;

  })();

  module.exports = TabSet;

}).call(this);
